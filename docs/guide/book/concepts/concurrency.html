<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Concurrency Control in SCIM Operations - SCIM Server Guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SCIM Server Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="concurrency-control-in-scim-operations"><a class="header" href="#concurrency-control-in-scim-operations">Concurrency Control in SCIM Operations</a></h1>
<p>SCIM operations often involve multiple clients accessing and modifying the same identity resources simultaneously. Without proper concurrency control, this can lead to data corruption, lost updates, and inconsistent system state. This chapter explores how the SCIM Server library provides automatic concurrency protection through version-based optimistic locking.</p>
<h2 id="the-concurrency-challenge"><a class="header" href="#the-concurrency-challenge">The Concurrency Challenge</a></h2>
<p>Consider a common scenario: two HR administrators are simultaneously updating the same user record. Admin A is adding the user to a new department group, while Admin B is updating the user's job title. Without concurrency control, the last update wins—potentially causing one administrator's changes to be silently lost.</p>
<p>This problem becomes more acute in modern distributed systems where identity data is managed across multiple applications, each making updates through SCIM APIs. Traditional database locking mechanisms are insufficient because SCIM operates over HTTP, where connections are short-lived and stateless.</p>
<p><strong>The Lost Update Problem</strong>: When multiple clients read a resource, modify it, and write it back, the client that writes last unknowingly overwrites changes made by other clients. This is particularly dangerous for identity data where access rights, group memberships, and security attributes must remain consistent.</p>
<h2 id="when-concurrency-control-matters"><a class="header" href="#when-concurrency-control-matters">When Concurrency Control Matters</a></h2>
<p>Understanding when to enable concurrency protection is crucial for system design and performance.</p>
<h3 id="multi-client-scenarios-concurrency-control-required"><a class="header" href="#multi-client-scenarios-concurrency-control-required">Multi-Client Scenarios (Concurrency Control Required)</a></h3>
<p><strong>Enterprise Identity Management</strong>: Multiple identity providers (HR systems, Active Directory, Okta) synchronizing user data with your application. Each system may attempt to update user attributes simultaneously based on their internal schedules.</p>
<p><strong>Administrative Interfaces</strong>: Multiple administrators managing users through web interfaces. Without concurrency control, one administrator can unknowingly overwrite changes made by another, leading to confusion and data loss.</p>
<p><strong>Automated Provisioning</strong>: Identity lifecycle management systems that automatically create, update, and deactivate users based on business rules. These systems often operate concurrently and need protection against conflicting updates.</p>
<p><strong>Integration Scenarios</strong>: Applications integrating with multiple identity sources (LDAP, Azure AD, Google Workspace) where changes from different sources may arrive simultaneously.</p>
<h3 id="single-client-scenarios-concurrency-control-optional"><a class="header" href="#single-client-scenarios-concurrency-control-optional">Single-Client Scenarios (Concurrency Control Optional)</a></h3>
<p><strong>Dedicated Integration</strong>: A single HR system that is the sole source of truth for user data. Since only one client makes updates, there's no risk of concurrent modification conflicts.</p>
<p><strong>Batch Processing</strong>: Scheduled data synchronization where updates are processed sequentially by a single system during maintenance windows.</p>
<p><strong>Development and Testing</strong>: Development environments where only one developer or test suite is making changes.</p>
<p><strong>Read-Heavy Workloads</strong>: Applications that primarily read identity data with infrequent updates from a single source.</p>
<h2 id="http-etag-vs-mcp-version-handling"><a class="header" href="#http-etag-vs-mcp-version-handling">HTTP ETag vs MCP Version Handling</a></h2>
<p>The SCIM Server library supports two distinct version management approaches, each optimized for different integration patterns.</p>
<h3 id="http-etag-integration"><a class="header" href="#http-etag-integration">HTTP ETag Integration</a></h3>
<p><strong>Protocol Context</strong>: HTTP ETags are part of the HTTP 1.1 specification (RFC 7232) and provide standard web caching and conditional request mechanisms. They're familiar to web developers and integrate seamlessly with existing HTTP infrastructure.</p>
<p><strong>Format</strong>: ETags appear as HTTP headers with quoted strings: <code>ETag: W/"abc123def"</code>. The <code>W/</code> prefix indicates a "weak" ETag, meaning it represents semantic equivalence rather than byte-for-byte identity.</p>
<p><strong>Usage Pattern</strong>: Web applications and REST clients naturally work with ETags through standard HTTP headers:</p>
<pre><code class="language-http">GET /Users/123
Response: ETag: W/"v1.2.3"

PUT /Users/123
If-Match: W/"v1.2.3"
</code></pre>
<p><strong>Integration Benefits</strong>: Works automatically with HTTP caches, proxies, and standard web frameworks. No special client-side handling needed—just standard HTTP conditional request headers.</p>
<h3 id="mcp-version-handling"><a class="header" href="#mcp-version-handling">MCP Version Handling</a></h3>
<p><strong>Protocol Context</strong>: Model Context Protocol (MCP) operates over JSON-RPC rather than HTTP, making traditional ETags inappropriate. MCP versions use raw string identifiers that are more suitable for programmatic access.</p>
<p><strong>Format</strong>: Raw version strings without HTTP formatting: <code>"abc123def"</code>. No quotes, no <code>W/</code> prefix, just the opaque version identifier.</p>
<p><strong>Usage Pattern</strong>: JSON-RPC clients work directly with version strings in request/response payloads:</p>
<pre><code class="language-json">{
  "method": "scim_update_user",
  "params": {
    "user_data": {...},
    "expected_version": "abc123def"
  }
}
</code></pre>
<p><strong>Integration Benefits</strong>: Cleaner for programmatic access, especially in AI agents and automated tools that work with JSON data structures rather than HTTP headers.</p>
<h2 id="architecture-raw-types-with-format-safety"><a class="header" href="#architecture-raw-types-with-format-safety">Architecture: Raw Types with Format Safety</a></h2>
<p>The SCIM Server library uses a sophisticated type system to prevent version format confusion while maintaining compatibility with both HTTP and MCP protocols.</p>
<h3 id="internal-raw-representation"><a class="header" href="#internal-raw-representation">Internal Raw Representation</a></h3>
<p><strong>Core Concept</strong>: All versions are stored internally as raw, opaque strings. This provides a canonical representation that's independent of the client protocol being used.</p>
<p><strong>Benefits</strong>: Storage systems, databases, and internal processing logic work with a single, consistent version format. No protocol-specific encoding in your data layer.</p>
<p><strong>Content-Based Generation</strong>: Versions can be generated from resource content using SHA-256 hashing, ensuring deterministic versioning across different systems and eliminating the need for centralized version counters.</p>
<h3 id="type-safe-format-conversion"><a class="header" href="#type-safe-format-conversion">Type-Safe Format Conversion</a></h3>
<p><strong>Phantom Types</strong>: The library uses Rust's phantom type system to distinguish between different version formats at compile time:</p>
<ul>
<li><code>RawVersion</code>: Internal canonical format ("abc123def")</li>
<li><code>HttpVersion</code>: HTTP ETag format ("W/"abc123def"")</li>
</ul>
<p><strong>Compile-Time Safety</strong>: The type system prevents accidentally mixing formats. You cannot pass an HTTP ETag where a raw version is expected—the compiler catches these errors before deployment.</p>
<p><strong>Automatic Conversions</strong>: Standard Rust traits handle conversions between formats:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let raw_version = RawVersion::from_hash("abc123");
let http_version = HttpVersion::from(raw_version);  // Conversion
let etag_header = http_version.to_string();        // "W/\"abc123\""
<span class="boring">}</span></code></pre></pre>
<p><strong>Cross-Format Equality</strong>: Versions with the same underlying content are equal regardless of format, enabling seamless comparison between HTTP and MCP clients working on the same data.</p>
<h2 id="implementation-patterns"><a class="header" href="#implementation-patterns">Implementation Patterns</a></h2>
<h3 id="automatic-version-generation"><a class="header" href="#automatic-version-generation">Automatic Version Generation</a></h3>
<p><strong>Content-Based Versioning</strong>: The library automatically generates versions from resource content, ensuring that any change to user data results in a new version. This eliminates the need for manual version management in your application code.</p>
<p><strong>Provider Integration</strong>: Resource providers automatically handle version computation and comparison. Your storage layer works with raw versions, while the protocol handlers manage format conversion transparently.</p>
<h3 id="conditional-operations"><a class="header" href="#conditional-operations">Conditional Operations</a></h3>
<p><strong>Built-In Protection</strong>: All update and delete operations include conditional variants that check versions before making changes. This protection is automatic—no additional code required in your business logic.</p>
<p><strong>Graceful Conflict Handling</strong>: When version mismatches occur, the library provides detailed conflict information including expected vs. current versions and human-readable error messages for client display.</p>
<p><strong>Flexible Response</strong>: Your application can choose to retry with updated versions, merge changes intelligently, or present conflicts to users for manual resolution.</p>
<h2 id="best-practices-for-concurrency-design"><a class="header" href="#best-practices-for-concurrency-design">Best Practices for Concurrency Design</a></h2>
<h3 id="choose-based-on-client-count"><a class="header" href="#choose-based-on-client-count">Choose Based on Client Count</a></h3>
<p><strong>Single Client</strong>: If your SCIM server serves only one client system, concurrency control adds overhead without benefits. Use simple operations without version checking.</p>
<p><strong>Multiple Clients</strong>: Enable concurrency control when multiple systems update the same resources. The performance overhead is minimal compared to the data integrity benefits.</p>
<h3 id="version-management-strategy"><a class="header" href="#version-management-strategy">Version Management Strategy</a></h3>
<p><strong>Let the Library Handle It</strong>: Use automatic content-based versioning rather than implementing your own version schemes. The library's approach is proven, consistent, and integrates with both HTTP and MCP protocols.</p>
<p><strong>Store Raw Versions</strong>: Keep the canonical raw version format in your database. Let the protocol handlers convert to appropriate formats (ETag headers or JSON fields) as needed.</p>
<h3 id="error-handling-design"><a class="header" href="#error-handling-design">Error Handling Design</a></h3>
<p><strong>Expect Version Conflicts</strong>: Design your client applications to handle version mismatch errors gracefully. Provide clear user feedback and options for conflict resolution.</p>
<p><strong>Implement Retry Logic</strong>: For automated systems, implement exponential backoff retry with fresh version retrieval when conflicts occur.</p>
<h2 id="integration-with-modern-identity-systems"><a class="header" href="#integration-with-modern-identity-systems">Integration with Modern Identity Systems</a></h2>
<h3 id="cloud-identity-providers"><a class="header" href="#cloud-identity-providers">Cloud Identity Providers</a></h3>
<p><strong>Multi-Provider Scenarios</strong>: Modern enterprises often integrate multiple identity providers (Azure AD, Okta, Google Workspace) with SCIM endpoints. Concurrency control prevents conflicts when these systems synchronize user data simultaneously.</p>
<p><strong>Eventual Consistency</strong>: Concurrency control provides immediate consistency for SCIM operations while allowing eventual consistency patterns in your broader identity architecture.</p>
<h3 id="ai-and-automation"><a class="header" href="#ai-and-automation">AI and Automation</a></h3>
<p><strong>AI Agent Integration</strong>: AI systems making identity management decisions benefit from MCP version handling, which provides cleaner programmatic access compared to HTTP header parsing.</p>
<p><strong>Automated Compliance</strong>: Compliance systems that automatically update user attributes based on policy changes need concurrency protection to avoid overwriting simultaneous manual administrative changes.</p>
<h2 id="performance-considerations"><a class="header" href="#performance-considerations">Performance Considerations</a></h2>
<h3 id="minimal-overhead"><a class="header" href="#minimal-overhead">Minimal Overhead</a></h3>
<p><strong>Lightweight Versioning</strong>: Version computation uses SHA-256 hashing of JSON content, which is fast and deterministic. The performance impact is negligible compared to database operations.</p>
<p><strong>No Database Locking</strong>: Optimistic concurrency control avoids database locks, maintaining high throughput for read operations and simple updates.</p>
<h3 id="scalability-benefits"><a class="header" href="#scalability-benefits">Scalability Benefits</a></h3>
<p><strong>Horizontal Scaling</strong>: Version-based concurrency control works across multiple server instances without coordination, enabling horizontal scaling of SCIM endpoints.</p>
<p><strong>Caching Compatibility</strong>: HTTP ETag integration works seamlessly with web caches and CDNs, potentially reducing server load for read-heavy workloads.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>Concurrency control in SCIM operations provides essential data integrity protection for multi-client scenarios while remaining optional for simple single-client integrations. The SCIM Server library's version-based approach offers automatic protection with minimal performance overhead, type-safe format handling, and seamless integration with both HTTP and MCP protocols.</p>
<p>By understanding when concurrency control is needed and how the library's type-safe architecture prevents common version handling errors, you can build robust identity management systems that maintain data consistency even under concurrent access patterns.</p>
<p>The key insight is matching your concurrency strategy to your integration pattern: use the protection when you need it, skip it when you don't, and let the library handle the complex details of version management and format conversion automatically.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../concepts/schema-mechanisms.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../concepts/schema-mechanisms.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
