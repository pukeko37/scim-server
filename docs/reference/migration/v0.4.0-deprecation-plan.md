# v0.4.0 Deprecation and Removal Plan

## Overview

This document outlines the plan for removing the deprecated `InMemoryProvider` in version 0.4.0 and completing the transition to the new `StandardResourceProvider<S>` architecture.

## Timeline

- **v0.3.0** (2025-08-14): `InMemoryProvider` deprecated, `StandardResourceProvider` introduced
- **v0.3.x** (2025-08-15 - 2025-11-30): Deprecation period with migration support
- **v0.4.0** (2025-12-01): `InMemoryProvider` removed, breaking changes implemented

## Deprecation Period (v0.3.x)

### Migration Support
During the deprecation period, we will:

1. **Maintain Full Functionality**: `InMemoryProvider` continues to work exactly as before
2. **Add Deprecation Warnings**: Compile-time warnings guide users to migrate
3. **Provide Migration Tools**: Automated tools to help with code migration
4. **Offer Support**: Documentation, examples, and community support for migration

### Deprecation Warnings
```rust
#[deprecated(
    since = "0.3.0",
    note = "InMemoryProvider is deprecated. Use StandardResourceProvider<InMemoryStorage> instead. See migration guide at docs/migration-v0.4.md"
)]
pub struct InMemoryProvider {
    // ... existing implementation
}
```

### Migration Tools
We will provide automated migration assistance:

```bash
# Cargo command to help migrate code
cargo scim-migrate --from inmemory-provider --to standard-provider

# Example output:
# Found 5 instances of InMemoryProvider usage:
# - src/main.rs:15: let provider = InMemoryProvider::new();
# - src/server.rs:23: fn setup(provider: InMemoryProvider) -> ...
# 
# Suggested changes:
# - Add import: use scim_server::storage::InMemoryStorage;
# - Replace: let provider = StandardResourceProvider::new(InMemoryStorage::new());
```

## v0.4.0 Breaking Changes

### Removed Components

#### 1. InMemoryProvider Struct
```rust
// REMOVED in v0.4.0
pub struct InMemoryProvider { ... }
```

**Migration Path**:
```rust
// Before (v0.3.x)
use scim_server::providers::InMemoryProvider;
let provider = InMemoryProvider::new();

// After (v0.4.0+)
use scim_server::{
    providers::StandardResourceProvider,
    storage::InMemoryStorage,
};
let provider = StandardResourceProvider::new(InMemoryStorage::new());
```

#### 2. InMemoryProvider Implementation
```rust
// REMOVED in v0.4.0
impl ResourceProvider for InMemoryProvider { ... }
```

#### 3. Related Helper Functions
```rust
// REMOVED in v0.4.0
impl InMemoryProvider {
    pub fn new() -> Self { ... }
    pub fn with_capacity(capacity: usize) -> Self { ... }
    pub async fn get_stats(&self) -> InMemoryStats { ... }
    // ... other InMemoryProvider-specific methods
}
```

### Module Restructuring

#### Before (v0.3.x)
```
src/
├── providers/
│   ├── mod.rs
│   ├── in_memory.rs          # Contains InMemoryProvider
│   └── standard.rs           # Contains StandardResourceProvider
└── storage/
    ├── mod.rs
    └── in_memory.rs          # Contains InMemoryStorage
```

#### After (v0.4.0)
```
src/
├── providers/
│   ├── mod.rs
│   └── standard.rs           # Only StandardResourceProvider
└── storage/
    ├── mod.rs
    ├── in_memory.rs
    ├── sqlite.rs             # New in Phase 3
    └── postgres.rs           # New in Phase 3
```

### Import Changes

#### Removed Imports
```rust
// REMOVED in v0.4.0
pub use providers::InMemoryProvider;
pub use providers::in_memory::{InMemoryProvider, InMemoryError, InMemoryStats};
```

#### Updated Re-exports
```rust
// v0.4.0 public API
pub use providers::StandardResourceProvider;
pub use storage::{
    InMemoryStorage, StorageProvider, StorageKey, StoragePrefix,
    SqliteStorage, PostgresStorage, // Added in Phase 3
};
```

## Code Migration Requirements

### Automatic Migration Cases
These changes can be automated with tooling:

1. **Simple Provider Creation**
   ```rust
   // Before
   let provider = InMemoryProvider::new();
   
   // After (automated)
   let provider = StandardResourceProvider::new(InMemoryStorage::new());
   ```

2. **Type Annotations**
   ```rust
   // Before
   fn setup() -> InMemoryProvider { ... }
   
   // After (automated)
   fn setup() -> StandardResourceProvider<InMemoryStorage> { ... }
   ```

3. **Import Statements**
   ```rust
   // Before
   use scim_server::providers::InMemoryProvider;
   
   // After (automated)
   use scim_server::{
       providers::StandardResourceProvider,
       storage::InMemoryStorage,
   };
   ```

### Manual Migration Cases
These require developer attention:

1. **Generic Functions**
   ```rust
   // Before
   fn process_provider(provider: InMemoryProvider) { ... }
   
   // After (manual decision needed)
   fn process_provider<S: StorageProvider>(provider: StandardResourceProvider<S>) { ... }
   // OR
   fn process_provider(provider: StandardResourceProvider<InMemoryStorage>) { ... }
   ```

2. **Struct Fields**
   ```rust
   // Before
   struct MyService {
       provider: InMemoryProvider,
   }
   
   // After (manual decision needed)
   struct MyService<S: StorageProvider> {
       provider: StandardResourceProvider<S>,
   }
   // OR
   struct MyService {
       provider: StandardResourceProvider<InMemoryStorage>,
   }
   ```

3. **Clone Usage**
   ```rust
   // Before
   let provider = InMemoryProvider::new();
   let cloned = provider.clone(); // This worked
   
   // After (manual fix needed)
   let provider = Arc::new(StandardResourceProvider::new(InMemoryStorage::new()));
   let cloned = provider.clone(); // Arc<T> implements Clone
   ```

## Testing Migration

### Test Suite Updates
All tests will be updated to use the new provider:

```rust
// Before
#[tokio::test]
async fn test_user_creation() {
    let provider = InMemoryProvider::new();
    // ... test implementation
}

// After
#[tokio::test]
async fn test_user_creation() {
    let storage = InMemoryStorage::new();
    let provider = StandardResourceProvider::new(storage);
    // ... test implementation (unchanged)
}
```

### Backward Compatibility Tests
```rust
// These tests will be REMOVED in v0.4.0
#[cfg(feature = "legacy-tests")]
mod legacy_inmemory_tests {
    // Tests that verify InMemoryProvider still works
    // Only available in v0.3.x
}
```

## Documentation Updates

### Updated Examples
All examples will be updated:

- `examples/basic_usage.rs` ✅ (Already updated)
- `examples/provider_modes.rs` ✅ (Already updated)
- `examples/multi_tenant_example.rs` ✅ (Already updated)
- `examples/etag_concurrency_example.rs` ✅ (Already updated)
- All other examples in `/examples` directory

### API Documentation
- Remove all references to `InMemoryProvider` from rustdoc
- Update all code examples to use `StandardResourceProvider`
- Add clear migration notes in appropriate places

### Migration Guide Updates
The migration guide (`docs/migration-v0.4.md`) will be updated with:
- v0.4.0 specific breaking changes
- Final migration checklist
- Troubleshooting for common v0.4.0 issues

## Release Process

### Pre-Release Testing (v0.4.0-rc.1)
1. **Automated Migration Testing**
   ```bash
   # Test migration tools on real codebases
   ./test-migration.sh --target examples/
   ./test-migration.sh --target tests/
   ```

2. **Community Testing**
   - Release candidate for community feedback
   - Test migration on popular projects using scim-server
   - Gather feedback on migration experience

3. **Breaking Change Verification**
   ```bash
   # Ensure InMemoryProvider is completely removed
   cargo check 2>&1 | grep -i "inmemoryprovider" || echo "✅ InMemoryProvider successfully removed"
   ```

### v0.4.0 Release Checklist
- [ ] All `InMemoryProvider` code removed
- [ ] All tests updated and passing
- [ ] All examples updated
- [ ] Documentation updated
- [ ] Migration tools tested
- [ ] CHANGELOG updated with breaking changes
- [ ] Release notes prepared
- [ ] Community notified of final migration deadline

## Communication Plan

### Community Notification Timeline

#### 3 Months Before (2025-09-01)
- **Blog post**: "Preparing for v0.4.0: InMemoryProvider Deprecation"
- **GitHub issue**: Pinned migration tracking issue
- **Discord/Forum**: Community discussion thread

#### 2 Months Before (2025-10-01)
- **Email newsletter**: Direct notification to known users
- **Reddit/HackerNews**: Community awareness post
- **Documentation**: Prominent migration notices

#### 1 Month Before (2025-11-01)
- **Final warning**: Last call for migration assistance
- **Release candidate**: v0.4.0-rc.1 with migration tools
- **Webinar/Stream**: Live migration demonstration

#### Release Day (2025-12-01)
- **Release announcement**: v0.4.0 official release
- **Migration success stories**: Showcase community migrations
- **Support**: Dedicated support for migration issues

### Support During Transition

#### Community Support
- Dedicated GitHub Discussions category for migration help
- Discord support channel with volunteer moderators
- Weekly office hours for live migration assistance

#### Enterprise Support
- Direct migration assistance for enterprise users
- Custom migration tooling for complex codebases
- Priority support tickets for migration-related issues

## Risk Mitigation

### Breaking Change Risks
1. **Risk**: Users miss deprecation notices
   - **Mitigation**: Multiple notification channels, prominent warnings

2. **Risk**: Complex codebases difficult to migrate
   - **Mitigation**: Automated migration tools, manual assistance

3. **Risk**: Third-party libraries depend on InMemoryProvider
   - **Mitigation**: Early notification to library maintainers

### Migration Failure Scenarios
1. **Scenario**: Migration tools fail on complex code
   - **Response**: Manual migration guide, community support

2. **Scenario**: Performance regression with new provider
   - **Response**: Performance tuning guide, optimization assistance

3. **Scenario**: Unexpected behavior changes
   - **Response**: Detailed behavioral comparison documentation

## Success Metrics

### Migration Success Indicators
- [ ] >95% of known users successfully migrated before v0.4.0
- [ ] <10 migration-related issues reported in first month
- [ ] Community sentiment positive about new architecture
- [ ] Documentation and examples reflect best practices

### Technical Success Criteria
- [ ] All tests pass with new provider architecture
- [ ] Performance equal or better than deprecated provider
- [ ] Code complexity reduced with unified provider interface
- [ ] Storage pluggability working as designed

## Post-v0.4.0 Plans

### Immediate (v0.4.1-v0.4.3)
- Fix any migration-related issues discovered
- Performance optimizations based on real usage
- Additional storage implementations (Phase 3)

### Medium-term (v0.5.0)
- Advanced features leveraging pluggable storage
- Performance improvements and optimizations
- Additional storage backends based on community needs

### Long-term (v1.0.0)
- Stable API with semantic versioning guarantees
- Production-ready for all major storage backends
- Comprehensive ecosystem of storage providers

## Conclusion

The removal of `InMemoryProvider` in v0.4.0 represents a significant architectural improvement that enables:

1. **Pluggable Storage**: Multiple backend implementations
2. **Better Testing**: Separation of concerns
3. **Production Readiness**: Real persistence options
4. **Future Growth**: Foundation for advanced features

While this is a breaking change, the migration path is clear, tooling is provided, and the benefits justify the transition effort. The deprecation period ensures users have sufficient time and support to migrate successfully.